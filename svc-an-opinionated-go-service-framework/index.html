<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta name=description content="I wrote a Go service framework that I use for my personal projects."><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200&family=Permanent+Marker&display=swap" rel=stylesheet><meta property="og:url" content="https://blog.gerbenjacobs.nl/svc-an-opinionated-go-service-framework/"><meta property="og:type" content="website"><meta property="og:title" content="svc; an opinionated Go service framework"><meta property="og:description" content="I wrote a Go service framework that I use for my personal projects."><meta property="og:image" content="https://blog.gerbenjacobs.nl/img/flickr-theonewithout-fencers.jpg"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="blog.gerbenjacobs.nl"><meta property="twitter:url" content="https://blog.gerbenjacobs.nl/svc-an-opinionated-go-service-framework/"><meta name=twitter:title content="svc; an opinionated Go service framework"><meta name=twitter:description content="I wrote a Go service framework that I use for my personal projects."><meta name=twitter:image content="https://blog.gerbenjacobs.nl/img/flickr-theonewithout-fencers.jpg"><meta itemprop=name content="svc; an opinionated Go service framework"><meta itemprop=description content="I wrote a Go service framework that I use for my personal projects."><meta itemprop=datePublished content="2022-06-17T00:00:00+00:00"><meta itemprop=dateModified content="2022-06-17T00:00:00+00:00"><meta itemprop=wordCount content="1213"><meta itemprop=keywords content="tech,go,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-KKSLTF3X24"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KKSLTF3X24",{anonymize_ip:!1})}</script><script src=/js/main.js></script><title>svc; an opinionated Go service framework | Gerben Jacobs</title></head><body class="d-flex flex-column h-100"><nav id=nav class="navbar navbar-expand-lg navbar-dark bg-dark"><div class=container-fluid><a class=navbar-brand href=/>Gerben Jacobs</a><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class=nav-item><a id=darkmode class="btn btn-primary" title="Toggle dark mode">üåì</a></li></ul></div></nav><div id=content class=container><div class="row justify-content-center"><div class="col-xl-6 col-lg-8 col-md-11"><article><header><h1>svc; an opinionated Go service framework</h1></header>üìÖ
<time datetime=2022-06-17>Jun 17, 2022</time> &mdash;
üßÆ 1213 words
&mdash; üè∑Ô∏è
<a href=https://blog.gerbenjacobs.nl/tags/tech><span class="badge bg-secondary">tech</span></a>
<a href=https://blog.gerbenjacobs.nl/tags/go><span class="badge bg-secondary">go</span></a><hr class=rainbow><strong>Table of contents</strong><nav id=TableOfContents><ul><li><a href=#svc>svc</a><ul><li><a href=#handlers>Handlers</a></li><li><a href=#services>Services</a></li><li><a href=#storages>Storages</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav><hr class=rainbow><p>I have been writing Go (or Golang) for about 6 years now. In that time I&rsquo;ve seen quite a few different ways
on how to organize a Go project. During my time at <a href=https://www.messagebird.com/>MessageBird</a> I got introduced to a nice layered approach.
I&rsquo;ve taken those lessons and applied them to something that feels right for me; <a href=https://github.com/gerbenjacobs/svc>github.com/gerbenjacobs/svc</a></p><h2 id=svc>svc</h2><p>svc is not an actual framework, but more a convention for creating microservices.</p><p>The core of svc is centered around 3 layers: <strong>handlers</strong>, <strong>services</strong> and <strong>storages</strong>.
Together with the <code>cmd</code> folder they are responsible for organizing your code into a clean and well-organized structure.</p><p>The idea is that requests only flow down the stack and answers flow up. These layers are connected via <strong>domain models</strong>.</p><p>Communication between the layers is done via interfaces. These are located in the file with the same name as the layer.
So in order to learn more about what kind of storages we have, for example, you can visit <code>/storages/storage.go</code>.</p><figure class=figure><img class="figure-img img-fluid rounded" src=/img/blog/2022/layers.png alt="The layers and directions of svc"><figcaption class=figure-caption>The layers and directions of svc</figcaption></figure><h3 id=handlers>Handlers</h3><p>Handler is a struct that acts as a dependency injection container.
They are the entry point for your application, everything is delegated from there.</p><p>They translate your requests into domain models and delegate the actual work to services, and vice versa.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Handler is your dependency container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Handler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mux</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Dependencies</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Dependencies contains all the dependencies your application and its services require
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Dependencies</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UserSvc</span>    <span style=color:#a6e22e>services</span>.<span style=color:#a6e22e>UserService</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WebhookSvc</span> <span style=color:#a6e22e>services</span>.<span style=color:#a6e22e>WebhookService</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Auth</span>       <span style=color:#f92672>*</span><span style=color:#a6e22e>services</span>.<span style=color:#a6e22e>Auth</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New creates a new handler given a set of dependencies
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>dependencies</span> <span style=color:#a6e22e>Dependencies</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Handler</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Handler</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Dependencies</span>: <span style=color:#a6e22e>dependencies</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#34;health&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/health&#34;</span>, <span style=color:#a6e22e>health</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/v1/user&#34;</span>, <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>createUser</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/v1/user&#34;</span>, <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>AuthMiddleware</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>readUser</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/v1/webhook/:webhookID&#34;</span>, <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>readWebhook</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The actual <code>main</code> function of your application then creates a new Handler and passes the required dependencies to it.
In this case it&rsquo;s set up as an HTTP server, but you could switch these out with GRPC for example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// set up the route handler and server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Dependencies</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Auth</span>:       <span style=color:#a6e22e>auth</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UserSvc</span>:    <span style=color:#a6e22e>userSvc</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WebhookSvc</span>: <span style=color:#a6e22e>webhookSvc</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Addr</span>:         <span style=color:#e6db74>&#34;:8080&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReadTimeout</span>:  <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WriteTimeout</span>: <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Handler</span>:      <span style=color:#a6e22e>app</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The route that&rsquo;s responsible for reading webhooks then relies on the webhook service. We know that the webhook service
replies with a <code>Webhook</code> model or an error and handle accordingly. In fact, we know about <code>ErrWebhookNotFound</code> and
can handle that differently, namely with a 404 status code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>readWebhook</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>p</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Params</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we go into our dependency container and get the webhook service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>webhook</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>WebhookSvc</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ByName</span>(<span style=color:#e6db74>&#34;webhookID&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// note that errors are also considered as domain models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>ErrWebhookNotFound</span>):
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusNotFound</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>error500</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// custom output format for webhooks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>webhookOutput</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>URL</span>         <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;url&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Triggers</span>    []<span style=color:#66d9ef>string</span>  <span style=color:#e6db74>`json:&#34;triggers&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TriggeredAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;triggered_at&#34;`</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// apparently our API docs are a bit different from our local domain model
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>whResp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>webhookOutput</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>URL</span>:         <span style=color:#a6e22e>webhook</span>.<span style=color:#a6e22e>URL</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Triggers</span>:    <span style=color:#a6e22e>webhook</span>.<span style=color:#a6e22e>Events</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TriggeredAt</span>: <span style=color:#a6e22e>webhook</span>.<span style=color:#a6e22e>UpdatedAt</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>whResp</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error500</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=services>Services</h3><p>Services are the glue between the layers. They are running the business logic of your application.
This includes business validation, collecting data from the storage layer, and any kind of generating, collecting or filtering.</p><p>The file <code>/services/service.go</code> contains the definition of the service interface. This interface is also part of
the dependencies in the handler.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserService</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>User</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>userID</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the file <code>/services/user.go</code> you can see how the service is implemented. We can&rsquo;t use the name <code>UserService</code> because
that&rsquo;s already taken by the interface. <em>This is also the reason I called the project <code>svc</code>, if I remember correctly.</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// UserSvc is our service struct that implements the services.UserService interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserSvc</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>storage</span> <span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>UserStorage</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>auth</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>Auth</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewUserSvc</span>(<span style=color:#a6e22e>userStorage</span> <span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>UserStorage</span>, <span style=color:#a6e22e>auth</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Auth</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UserSvc</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>UserSvc</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>storage</span>: <span style=color:#a6e22e>userStorage</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>auth</span>:    <span style=color:#a6e22e>auth</span>,
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// User returns the user based on the user ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>u</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserSvc</span>) <span style=color:#a6e22e>User</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>userID</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>userID</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Add adds a user to our service and repository
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>u</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserSvc</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>userID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>userID</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// create user object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>ID</span> = <span style=color:#a6e22e>userID</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Token</span> = <span style=color:#a6e22e>token</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UTC</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>CreatedAt</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>UpdatedAt</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// persist it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=storages>Storages</h3><p>Storages handle the persistence of the domain models. Sometimes these can be taken directly from the model,
sometimes they need to be converted to a storage model, or DAO if you wish.</p><p>In the file <code>/storages/storage.go</code> we can again find the interface. Having our storages be interfaces allows us
to easily swap out the storage implementation for testing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserStorage</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>userID</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AllUsers</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) []<span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s good to keep in mind that you&rsquo;re only allowed to communicate with domain models. You can see this in action
when dealing with MySQL errors, something the service should know nothing about.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>u</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserRepository</span>) <span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>userID</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>userID</span>.<span style=color:#a6e22e>MarshalBinary</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>QueryRowContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;SELECT id, name, token, createdAt, updatedAt FROM users WHERE id = ?&#34;</span>, <span style=color:#a6e22e>uid</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rationale: I&#39;m reusing the app.User here because the fields are quite primitive types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Depending on your scheme you could easily do some transformations here to change
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// app.User to a customer UserDAO struct, f.e. when your database engine stores bools as tinyints.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>User</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Token</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>CreatedAt</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>UpdatedAt</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rationale: Our service layer knows nothing about sql.ErrNoRows, but we at this point do
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that&#39;s why it&#39;s important to convert your database engine errors to common Domain model errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// that are known within the application.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// This specific example makes use of the %w verb to wrap errors with a custom message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>ErrNoRows</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;user with ID %q not found: %w&#34;</span>, <span style=color:#a6e22e>userID</span>, <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>ErrUserNotFound</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Rationale: Here we&#39;re explicitly not wrapping the error as the service shouldn&#39;t do anything with it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// However, if you started noticing these in your logs, you can probably handle them like the above case.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unknown error while scanning user: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>user</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>If you want to get separation of concerns and clarity when developing, this is a nice convention to follow.</p><ul><li>Your application is divided into layers.</li><li>Layers communicate with domain models via interfaces.</li><li>Handlers talk to services, services talk to other service and storages.</li></ul><p>I introduced this <em>framework</em> successfully at <a href=https://www.kramphub.nl/>Kramp Hub</a>, and it allowed the team to easily jump between
projects and quickly get started. We used GRPC so some interfaces were actually protobuf services, but other
than that it still worked the same.</p><p>I&rsquo;m also introducing it at <a href=https://www.github.com/>GitHub</a> with my team right now. This time however it&rsquo;s a bit more difficult.
The team is larger and the project is already quite large; perhaps not even <em>micro</em> anymore.
I&rsquo;ve switched from &ldquo;layers with packages&rdquo; to &ldquo;layers in packages&rdquo;. This is an ongoing process, so I might write a follow-up on that.</p></article><hr class=rainbow><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//gerbenjacobs.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="row justify-content-center"><div class="col-xl-6 col-lg-8 col-md-11"><div class=row><div class=col-md-6><div class=card><img src=https://blog.gerbenjacobs.nl/img/blog/2022/yiorgos-ntrahas-mcAUHlGirVs-unsplash.jpg class="card-img-top card-img-height" alt="My ROI stock portfolio experiment"><div class=card-body><span class=card-title title="My ROI stock portfolio experiment">My ROI stock portfolio...</span></div><div class=card-footer><a href=https://blog.gerbenjacobs.nl/my-roi-stock-portfolio-experiment/ class="btn btn-primary">&#171; Next</a></div></div></div><div class=col-md-6><div class=card><img src=https://blog.gerbenjacobs.nl/img/github-social.webp class="card-img-top card-img-height" alt="First month at GitHub"><div class=card-body><span class=card-title title="First month at GitHub">First month at GitHub</span></div><div class="card-footer text-end"><a href=https://blog.gerbenjacobs.nl/first-month-at-github/ class="btn btn-primary">Previous &#187;</a></div></div></div></div><div class=row><div class=col>Find any post in the <a href=/posts/archive/>archive</a>.</div></div></div></div></div><footer class="footer mt-4 py-3 bg-light rainbow" id=footer><p>Copyright &copy; 2022 Gerben Jacobs</p><a href=/index.xml><span class="badge p-1 footer-social" style=border-color:orange><img src=/img/social/rss.svg alt=RSS></span></a>
<a href=https://twitter.com/gerbenjacobs><span class="badge p-1 footer-social" style=border-color:#1da1f2><img src=/img/social/twitter.svg alt=Twitter></span></a>
<a href=https://github.com/gerbenjacobs><span class="badge p-1 footer-social" style=border-color:#181717><img src=/img/social/github.svg alt=GitHub></span></a>
<a href=https://todon.nl/@gerben rel=me><span class="badge p-1 footer-social" style=border-color:#6364ff><img src=/img/social/mastodon.svg alt=Mastodon></span></a>
<a href=https://linkedin.com/in/gerbenjacobs><span class="badge p-1 footer-social" style=border-color:#0a66c2><img src=/img/social/linkedin.svg alt=LinkedIn></span></a></footer><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4344810300258970" crossorigin=anonymous></script><button class=btn id=btn-back-to-top>‚òùÔ∏è</button></body></html>